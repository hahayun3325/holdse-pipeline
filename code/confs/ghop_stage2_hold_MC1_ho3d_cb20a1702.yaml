# Save as: confs/ghop_stage2_hold_MC1_ho3d_cb20a1702.yaml
# Based on official HOLD checkpoint cb20a1702

# ================================================================
# PHASE 3: GHOP SDS CONFIGURATION
# ================================================================

# Phase Configuration
phase3:
  enabled: true
  ghop:
    config_path: checkpoints/ghop/config.yaml
    device: cuda
    text_lib: null
    unet_checkpoint: checkpoints/ghop/last.ckpt
    unet_use_pretrained: true
    unified_checkpoint: checkpoints/ghop/last.ckpt
    vqvae_checkpoint: checkpoints/ghop/last.ckpt
    vqvae_use_pretrained: true

  grid_resolution: 24
  phase3_start_iter: 0
  phase3_end_iter: 60000      # 30 epochs × 2000 steps

  sds:
    diffusion_steps: 1000
    guidance_scale: 3.0
    max_step_ratio: 0.98
    min_step_ratio: 0.02
    noise_schedule: linear
    prediction_respacing: 50

  sds_iters: 1
  spatial_lim: 1.5
  use_modular_init: true
  w_sds: 10.0                 # Conservative start
  warmup_iters: 500

phase4:
  enabled: false              # Disable for Stage 2

phase5:
  enabled: false              # CRITICAL: Keep disabled!

# ================================================================
# MODEL: MUST MATCH OFFICIAL CHECKPOINT EXACTLY
# ================================================================
model:
  # ================================================================
  # IMPLICIT NETWORKS - Keep mostly as-is, but check embedder
  # ================================================================
  implicit_network:
    feature_vector_size: 256
    d_in: 3
    d_out: 1
    dims: [256, 256, 256, 256, 256, 256, 256, 256]  # 8 layers
    init: geometry
    bias: 0.6
    skip_in: [4]
    weight_norm: true
    multires: 6
    cond: pose

  # ================================================================
  # RENDERING NETWORKS - CRITICAL CHANGES HERE
  # ================================================================
  rendering_network:
    feature_vector_size: 256
    mode: pose
    d_in: 270                  # ← CHANGE from 14 to 270
    d_out: 3
    dims: [256, 256, 256, 256]
    weight_norm: true
    multires_view: 0           # ← Keep 0 (not -1, your code might not support -1)
    time_code_dim: 32          # ← ADD if your code supports it
    d_implicit_features: 256   # ← ADD if your code supports it

  bg_implicit_network:
    feature_vector_size: 256
    d_in: 4
    d_out: 1
    dims: [256, 256, 256, 256, 256, 256, 256, 256]  # ← 8 layers (official)
    init: none
    bias: 0.0
    skip_in: [4]
    weight_norm: false         # ← Official value (not true!)
    multires: 10
    cond: frame
    dim_frame_encoding: 32

  bg_rendering_network:
    feature_vector_size: 256
    mode: nerf_frame_encoding
    d_in: 315                  # ← CHANGE from 3 to 315
    d_out: 3
    dims: [128]
    weight_norm: false         # ← Official value (not true!)
    multires_view: 4
    dim_frame_encoding: 32

  density:
    params_init:
      beta: 0.1
    beta_min: 0.0001

  ray_sampler:
    near: 0.0
    N_samples: 64
    N_samples_eval: 128
    N_samples_extra: 32
    eps: 0.1
    beta_iters: 10
    max_total_iters: 5
    N_samples_inverse_sphere: 32
    add_tiny: 0.000001         # ← Add this (official has it)

# ================================================================
# DATASET & TRAINING
# ================================================================
dataset:
  train:
    type: train
    batch_size: 1              # Keep small for GHOP SDS
    drop_last: false
    shuffle: true
    num_workers: 4
    prefetch_factor: 2

  valid:
    type: val
    batch_size: 1
    drop_last: false
    shuffle: false
    pixel_per_batch: 512
    enabled: false             # Disable for faster training

# Loss Configuration
loss:
  w_rgb: 1.0
  w_mask: 0.1
  w_eikonal: 1.0
  w_smooth: 0.005
  w_temporal: 1.0
  rgb_loss_type: "l1"

# Training Configuration
training:
  num_epochs: 30
  max_steps: -1
  eval_every_epoch: 999
  log_every: 10
  gradient_clip: 1.0

# Optimizer Configuration
optimizer:
  lr: 0.0001
  type: "adam"
  weight_decay: 0.0

experiment:
  name: 'ghop_stage2_official_cb20a1702'