#!/bin/bash
# File: code/scripts/train_ghop_production.sh
# PURPOSE: Full production training with detailed summary analysis
# INCLUDES: Log analysis, Phase tracking, Error detection (from test_ghop_quick.sh)

set -e

cd ~/Projects/holdse/code

# ================================================================
# SETUP: Results directory
# ================================================================
RESULTS_DIR="../ghop_production_results"
mkdir -p "$RESULTS_DIR"

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
SUMMARY_FILE="$RESULTS_DIR/production_summary_$TIMESTAMP.txt"

echo ""
echo "========================================================================" | tee "$SUMMARY_FILE"
echo "GHOP PRODUCTION TRAINING - Bottle_1" | tee -a "$SUMMARY_FILE"
echo "========================================================================" | tee -a "$SUMMARY_FILE"
echo "Start: $(date)" | tee -a "$SUMMARY_FILE"
echo "" | tee -a "$SUMMARY_FILE"
echo "Configuration:" | tee -a "$SUMMARY_FILE"
echo "  Dataset:       ghop_bottle_1 (71 frames)" | tee -a "$SUMMARY_FILE"
echo "  Epochs:        20 (full training)" | tee -a "$SUMMARY_FILE"
echo "  Duration:      6-8 hours" | tee -a "$SUMMARY_FILE"
echo "  Expected:" | tee -a "$SUMMARY_FILE"
echo "    - Phase 5 ACTIVE at step 100" | tee -a "$SUMMARY_FILE"
echo "    - Temporal loss computed" | tee -a "$SUMMARY_FILE"
echo "    - Object SDF converges (Phase 4 activates)" | tee -a "$SUMMARY_FILE"
echo "========================================================================" | tee -a "$SUMMARY_FILE"
echo "" | tee -a "$SUMMARY_FILE"

# ================================================================
# STEP 1: Check if quick test config exists
# ================================================================
if [ ! -f "confs/ghop_quick_bottle_1.yaml" ]; then
    echo "‚ùå Error: confs/ghop_quick_bottle_1.yaml not found" | tee -a "$SUMMARY_FILE"
    echo "" | tee -a "$SUMMARY_FILE"
    echo "This config should have been generated by test_ghop_quick.sh" | tee -a "$SUMMARY_FILE"
    echo "Please run: bash scripts/test_ghop_quick.sh first" | tee -a "$SUMMARY_FILE"
    echo "" | tee -a "$SUMMARY_FILE"
    exit 1
fi

echo "‚úì Found working config: confs/ghop_quick_bottle_1.yaml" | tee -a "$SUMMARY_FILE"
echo "" | tee -a "$SUMMARY_FILE"

# ================================================================
# STEP 2: Copy and modify config
# ================================================================
echo "Creating production config..." | tee -a "$SUMMARY_FILE"

cp confs/ghop_quick_bottle_1.yaml confs/ghop_production_bottle_1.yaml

# Modify training parameters
sed -i 's/num_epochs: 1/num_epochs: 20/' confs/ghop_production_bottle_1.yaml
sed -i 's/max_steps: 20/max_steps: -1/' confs/ghop_production_bottle_1.yaml

# ================================================================
# ADD THESE LINES: Disable validation in config
# ================================================================
echo "" >> confs/ghop_production_bottle_1.yaml
echo "# Disable validation (GHOP dataset compatibility)" >> confs/ghop_production_bottle_1.yaml
echo "trainer:" >> confs/ghop_production_bottle_1.yaml
echo "  limit_val_batches: 0" >> confs/ghop_production_bottle_1.yaml
echo "  num_sanity_val_steps: 0" >> confs/ghop_production_bottle_1.yaml

echo "‚úì Created: confs/ghop_production_bottle_1.yaml" | tee -a "$SUMMARY_FILE"
echo "‚úì Validation disabled for GHOP compatibility" | tee -a "$SUMMARY_FILE"
echo "" | tee -a "$SUMMARY_FILE"

# ================================================================
# STEP 3: Verify config completeness
# ================================================================
echo "Verifying config..." | tee -a "$SUMMARY_FILE"

required_sections=(
    "implicit_network"
    "rendering_network"
    "density"
    "ray_sampler"
    "phase5"
)

all_present=true
for section in "${required_sections[@]}"; do
    if grep -q "$section:" confs/ghop_production_bottle_1.yaml; then
        echo "  ‚úÖ $section: present" | tee -a "$SUMMARY_FILE"
    else
        echo "  ‚ùå $section: MISSING" | tee -a "$SUMMARY_FILE"
        all_present=false
    fi
done

if [ "$all_present" = false ]; then
    echo "" | tee -a "$SUMMARY_FILE"
    echo "‚ùå Config incomplete - aborting" | tee -a "$SUMMARY_FILE"
    exit 1
fi

echo "" | tee -a "$SUMMARY_FILE"
echo "‚úÖ Config complete" | tee -a "$SUMMARY_FILE"
echo "" | tee -a "$SUMMARY_FILE"

# ================================================================
# STEP 4: Run production training
# ================================================================
LOG_FILE="$RESULTS_DIR/production_bottle_1_$TIMESTAMP.log"

echo "Starting training..." | tee -a "$SUMMARY_FILE"
echo "  Command: python train.py --config confs/ghop_production_bottle_1.yaml --case ghop_bottle_1 --use_ghop --gpu_id 0 --num_epoch 20" | tee -a "$SUMMARY_FILE"
echo "  Log: $LOG_FILE" | tee -a "$SUMMARY_FILE"
echo "" | tee -a "$SUMMARY_FILE"

START_TIME=$(date +%s)

# Run training (validation disabled via config)
python train.py \
    --config confs/ghop_production_bottle_1.yaml \
    --case ghop_bottle_1 \
    --use_ghop \
    --gpu_id 0 \
    --num_epoch 20 2>&1 | tee "$LOG_FILE"

exitcode=$?
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo "" | tee -a "$SUMMARY_FILE"
echo "========================================================================" | tee -a "$SUMMARY_FILE"

# ================================================================
# STEP 5: DETAILED ANALYSIS (from test_ghop_quick.sh)
# ================================================================
echo "ANALYSIS" | tee -a "$SUMMARY_FILE"
echo "========================================================================" | tee -a "$SUMMARY_FILE"
echo "" | tee -a "$SUMMARY_FILE"

# Training Status
if [ $exitcode -eq 0 ]; then
    echo "‚úÖ Training Status: COMPLETED" | tee -a "$SUMMARY_FILE"
else
    echo "‚ùå Training Status: FAILED (exit code: $exitcode)" | tee -a "$SUMMARY_FILE"
fi

# Duration
hours=$((DURATION / 3600))
minutes=$(((DURATION % 3600) / 60))
seconds=$((DURATION % 60))
echo "  Duration: ${hours}h ${minutes}m ${seconds}s" | tee -a "$SUMMARY_FILE"
echo "" | tee -a "$SUMMARY_FILE"

# Dataset Analysis
echo "üìä Dataset:" | tee -a "$SUMMARY_FILE"
if grep -q "GHOPHOIDataset\|GHOP HOI4D" "$LOG_FILE"; then
    echo "  ‚úÖ GHOP HOI4D dataset loaded" | tee -a "$SUMMARY_FILE"
    grep "Total frames\|Frame pairs\|Category" "$LOG_FILE" | head -5 | sed 's/^/    /' | tee -a "$SUMMARY_FILE"
else
    echo "  ‚ùå Dataset NOT loaded" | tee -a "$SUMMARY_FILE"
fi
echo "" | tee -a "$SUMMARY_FILE"

# Phase 5 Temporal Analysis
echo "üéØ Phase 5 - Temporal Consistency:" | tee -a "$SUMMARY_FILE"
if grep -q "phase5\|Phase 5.*ACTIVATE" "$LOG_FILE"; then
    echo "  ‚úÖ Phase 5 ACTIVATED" | tee -a "$SUMMARY_FILE"

    # Count temporal loss occurrences
    temporal_count=$(grep -c "phase5.*temporal" "$LOG_FILE" || echo "0")
    echo "  Temporal loss logged: $temporal_count times" | tee -a "$SUMMARY_FILE"

    # Show sample temporal losses
    if [ "$temporal_count" -gt 0 ]; then
        echo "" | tee -a "$SUMMARY_FILE"
        echo "  Sample temporal losses:" | tee -a "$SUMMARY_FILE"
        grep "phase5.*temporal" "$LOG_FILE" | head -10 | sed 's/^/    /' | tee -a "$SUMMARY_FILE"
    fi
else
    echo "  ‚ö†Ô∏è Phase 5 NOT activated (step < 100)" | tee -a "$SUMMARY_FILE"
fi
echo "" | tee -a "$SUMMARY_FILE"

# Training Progress Analysis
echo "üìà Training Progress:" | tee -a "$SUMMARY_FILE"
if grep -q "train_loss\|Epoch.*Step" "$LOG_FILE"; then
    echo "  ‚úÖ Training progressed" | tee -a "$SUMMARY_FILE"

    # Count completed epochs
    completed_epochs=$(grep -c "Epoch.*100%" "$LOG_FILE" || echo "0")
    echo "  Completed epochs: $completed_epochs / 20" | tee -a "$SUMMARY_FILE"

    # Show recent progress
    echo "" | tee -a "$SUMMARY_FILE"
    echo "  Recent training losses:" | tee -a "$SUMMARY_FILE"
    grep "Epoch\|train.*loss" "$LOG_FILE" | tail -15 | sed 's/^/    /' | tee -a "$SUMMARY_FILE"

    # Extract final loss if available
    final_loss=$(grep "train.*loss" "$LOG_FILE" | tail -1 | grep -oP "loss[=:]?\s*\K[0-9.]+")
    if [ -n "$final_loss" ]; then
        echo "" | tee -a "$SUMMARY_FILE"
        echo "  Final loss: $final_loss" | tee -a "$SUMMARY_FILE"
    fi
else
    echo "  ‚ùå No training progress found" | tee -a "$SUMMARY_FILE"
fi
echo "" | tee -a "$SUMMARY_FILE"

# Phase 3 GHOP Analysis
echo "ü§ñ Phase 3 - GHOP SDS:" | tee -a "$SUMMARY_FILE"
if grep -q "ghop.*sds_loss\|GHOP.*SDS" "$LOG_FILE"; then
    echo "  ‚úÖ GHOP SDS active" | tee -a "$SUMMARY_FILE"

    # Count SDS loss occurrences
    sds_count=$(grep -c "ghop.*sds_loss" "$LOG_FILE" || echo "0")
    echo "  SDS loss logged: $sds_count times" | tee -a "$SUMMARY_FILE"

    # Check if SDS loss is non-zero
    if grep "ghop.*sds_loss.*[1-9]" "$LOG_FILE" > /dev/null; then
        echo "  ‚úÖ SDS loss non-zero (VQ-VAE working)" | tee -a "$SUMMARY_FILE"
    else
        echo "  ‚ö†Ô∏è SDS loss = 0.0 (VQ-VAE random init)" | tee -a "$SUMMARY_FILE"
    fi
else
    echo "  ‚ö†Ô∏è GHOP SDS not detected" | tee -a "$SUMMARY_FILE"
fi
echo "" | tee -a "$SUMMARY_FILE"

# Phase 4 Contact Analysis
echo "ü§ù Phase 4 - Contact Refinement:" | tee -a "$SUMMARY_FILE"
if grep -q "phase4\|contact.*loss" "$LOG_FILE"; then
    echo "  ‚úÖ Phase 4 initialized" | tee -a "$SUMMARY_FILE"

    # Check if contact loss was computed
    if grep "phase4.*contact_loss.*[1-9]" "$LOG_FILE" > /dev/null; then
        echo "  ‚úÖ Contact loss computed (object SDF converged)" | tee -a "$SUMMARY_FILE"
    else
        echo "  ‚ö†Ô∏è Contact loss skipped (object SDF not ready)" | tee -a "$SUMMARY_FILE"
    fi
else
    echo "  ‚ö†Ô∏è Phase 4 not detected" | tee -a "$SUMMARY_FILE"
fi
echo "" | tee -a "$SUMMARY_FILE"

# Error Analysis
echo "‚ö†Ô∏è Error Analysis:" | tee -a "$SUMMARY_FILE"
if grep -qi "error\|exception\|RuntimeError" "$LOG_FILE" | head -1; then
    echo "  ‚ö†Ô∏è Errors/warnings found:" | tee -a "$SUMMARY_FILE"
    grep -i "error\|exception\|RuntimeError" "$LOG_FILE" | head -10 | sed 's/^/    /' | tee -a "$SUMMARY_FILE"
else
    echo "  ‚úÖ No errors detected" | tee -a "$SUMMARY_FILE"
fi
echo "" | tee -a "$SUMMARY_FILE"

# Checkpoint Analysis
echo "üíæ Checkpoints:" | tee -a "$SUMMARY_FILE"
checkpoint_dir="logs/ghop_bottle_1/checkpoints"
if [ -d "$checkpoint_dir" ]; then
    num_checkpoints=$(ls "$checkpoint_dir"/*.ckpt 2>/dev/null | wc -l)
    echo "  ‚úÖ Checkpoints saved: $num_checkpoints" | tee -a "$SUMMARY_FILE"

    if [ $num_checkpoints -gt 0 ]; then
        echo "  Latest checkpoints:" | tee -a "$SUMMARY_FILE"
        ls -lht "$checkpoint_dir"/*.ckpt | head -5 | awk '{print "    " $9 " (" $5 ")"}' | tee -a "$SUMMARY_FILE"
    fi
else
    echo "  ‚ö†Ô∏è No checkpoints directory found" | tee -a "$SUMMARY_FILE"
fi
echo "" | tee -a "$SUMMARY_FILE"

# ================================================================
# STEP 6: Summary and Recommendations
# ================================================================
echo "========================================================================" | tee -a "$SUMMARY_FILE"
echo "SUMMARY" | tee -a "$SUMMARY_FILE"
echo "========================================================================" | tee -a "$SUMMARY_FILE"

if [ $exitcode -eq 0 ] && [ "$completed_epochs" -ge 18 ]; then
    echo "‚úÖ PRODUCTION TRAINING SUCCESSFUL" | tee -a "$SUMMARY_FILE"
    echo "" | tee -a "$SUMMARY_FILE"
    echo "Key Achievements:" | tee -a "$SUMMARY_FILE"
    echo "  ‚úÖ All 20 epochs completed" | tee -a "$SUMMARY_FILE"
    echo "  ‚úÖ Phase 5 temporal consistency active" | tee -a "$SUMMARY_FILE"
    echo "  ‚úÖ Training converged successfully" | tee -a "$SUMMARY_FILE"
    echo "  ‚úÖ Model ready for evaluation" | tee -a "$SUMMARY_FILE"
elif [ $exitcode -eq 0 ]; then
    echo "‚ö†Ô∏è TRAINING COMPLETED WITH WARNINGS" | tee -a "$SUMMARY_FILE"
    echo "" | tee -a "$SUMMARY_FILE"
    echo "Issues:" | tee -a "$SUMMARY_FILE"
    echo "  ‚ö†Ô∏è Only $completed_epochs / 20 epochs completed" | tee -a "$SUMMARY_FILE"
    echo "  ‚ö†Ô∏è Consider rerunning with more time" | tee -a "$SUMMARY_FILE"
else
    echo "‚ùå TRAINING FAILED" | tee -a "$SUMMARY_FILE"
    echo "" | tee -a "$SUMMARY_FILE"
    echo "Next Steps:" | tee -a "$SUMMARY_FILE"
    echo "  1. Check log file for errors: $LOG_FILE" | tee -a "$SUMMARY_FILE"
    echo "  2. Review error analysis above" | tee -a "$SUMMARY_FILE"
    echo "  3. Fix issues and retry" | tee -a "$SUMMARY_FILE"
fi

echo "" | tee -a "$SUMMARY_FILE"
echo "========================================================================" | tee -a "$SUMMARY_FILE"
echo "End: $(date)" | tee -a "$SUMMARY_FILE"
echo "" | tee -a "$SUMMARY_FILE"
echo "üìÅ Results:" | tee -a "$SUMMARY_FILE"
echo "  Summary: $SUMMARY_FILE" | tee -a "$SUMMARY_FILE"
echo "  Log: $LOG_FILE" | tee -a "$SUMMARY_FILE"
echo "  Checkpoints: logs/ghop_bottle_1/checkpoints/" | tee -a "$SUMMARY_FILE"
echo "========================================================================" | tee -a "$SUMMARY_FILE"

exit $exitcode